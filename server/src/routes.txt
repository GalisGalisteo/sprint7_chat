import express from "express";
import { createMessage, createUser, getMessages, handleLogin } from "./application/controller";
import authenticate from "./infrastructure/middleware/auth";
import passport from "passport";
import { isLoggedIn } from "./infrastructure/middleware/isLoggedIn";

const router = express.Router();

router.get("/auth/google", 
passport.authenticate('google', { 
    scope: ['email', 'profile']
 }), (req, res) => {
    res.send(200);
})
router.get("/auth/google/callback", passport.authenticate("google", {
    successRedirect: "/api/success",
    failureRedirect: "/auth/failure"
}));

router.get("/auth/failure", (req, res) => {
    res.status(401).json({ error: "Authentication failed" });
});


router.get("/api/success", (req, res) => {
    if (req.user) {
        res.status(200).json(req.user);
    } else {
        res.status(401).json({ error: "Authentication failed" });
    }
});

router.post("/login", handleLogin)
router.post("/user", createUser);
router.post("/message/:user_id", isLoggedIn, createMessage)
router.get("/messages/", isLoggedIn, getMessages)

export default router;